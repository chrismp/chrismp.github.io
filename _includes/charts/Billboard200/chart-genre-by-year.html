<div id="genre-by-year-chart-container" class="chart">
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.js" charset="utf-8"></script>
<script type="text/javascript">
	var x, y, xAxis, yAxis;

	var genreByYearContainerID=	"genre-by-year-chart-container";
	var margin=	{
		top: 50,
		right: 30,
		bottom: 100,
		left: 0
	};
	var marginTop=		margin.top;
	var marginLeft=		margin.left;
	var marginBottom=	margin.bottom;
	var marginRight=	margin.right;

	var width=	document.getElementById(genreByYearContainerID).clientWidth - marginRight - marginLeft;

	var widthWithMargins=	width+marginRight+marginLeft;
	var height=				1000;

	var chart=		d3.select('#'+genreByYearContainerID)
					.append("svg");
	chart.attr('width',widthWithMargins)
		.attr("height",height);

	chart.append('g')
		.attr("transform","translate("+marginLeft+','+marginTop+')');

	var color=	d3.scale.category20();
	d3.csv("dummydata_genreCountByYear.csv", function(error, data){
		y=	d3.scale
			.ordinal()
			.rangeRoundBands([0,height - marginBottom], 0.1);

		x=	d3.scale
			.linear()
			// .rangeRound([height,0]);
			.range([0,width]);

		xAxis=	d3.svg.axis()
				.scale(x)
				.orient("top");

		yAxis=	d3.svg.axis()
				.scale(y)
				.orient("left");
				// .tickFormat(d3.format(".0%"));

		color.domain(d3.keys(data[0])
			.filter(function(key){
				return key !== "Year";
			}
		));

		data.forEach(function(d){
			var x0=	0;
			d.Genres=	color.domain().map(function(name){
				var obj=	{
					name:	name,
					x0:		x0,
					x1:		x0 += +d[name]
				};
				return obj;
			});

			d.Genres.forEach(function(d){
				d.x0 /= x0;
				d.x1 /= x0;
			});
		});

		data.sort(function(a,b){
			return b.Genres[0].x1 + a.Genres[0].x1;
		});

		y.domain(data.map(function(d){
			return d.Year;
		}));

		chart.append('g')
			.attr("class","y axis")
			// .attr("transform","translate(0,"+height+')')
			.call(yAxis);

		chart.append('g')
			.attr("class","x axis")
			.call(xAxis);

		var year=	chart.selectAll(".year")
					.data(data)
					.enter()
					.append('g')
					.attr("class","year")
					.attr("transform",function(d){
						return "translate(0,"+ y(d.Year)+")";
					});

		year.selectAll("rect")
			.data(function(d){
				return d.Genres;
			})
			.enter()
			.append("rect")
			.attr("height",y.rangeBand())
			.attr('x',function(d){
				return x(d.x0);
			})
			.attr("width",function(d){
				return (x(d.x0) - x(d.x1))*-1;
			})
			.style("fill",function(d){
				return color(d.name);
			});
	});
</script>